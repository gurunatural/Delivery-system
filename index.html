<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GURU Customer Directory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .glass-morphism {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid #ef4444; /* Red bottom border for header */
        }
        .customer-card {
            transition: transform 0.2s ease;
        }
        .customer-card:active {
            transform: scale(0.97);
        }
        .loader {
            border-top-color: #ef4444;
            animation: spinner 0.6s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }
        .selectable {
            user-select: text;
        }
        /* Prominent Search Bar style */
        .search-container {
            border: 2px solid #ef4444;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.15);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-gray-900">

    <!-- Header -->
    <header class="glass-morphism sticky top-0 z-30 px-4 py-3 shadow-md">
        <div class="max-w-4xl mx-auto text-center">
            <h1 class="text-xl font-black text-gray-900 uppercase tracking-tighter">
                GURU Customer Directory
            </h1>
            <p class="text-[10px] font-bold text-red-600 uppercase tracking-widest mt-0.5">
                Total Customers: <span id="customerCount">0</span>
            </p>
            
            <div class="relative mt-3 max-w-md mx-auto search-container rounded-xl overflow-hidden bg-white">
                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-red-500">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </span>
                <input 
                    type="text" 
                    id="searchInput"
                    placeholder="Search by Name, ID or Address..." 
                    class="w-full pl-10 pr-4 py-2.5 bg-transparent border-none focus:ring-0 outline-none font-bold text-gray-800"
                >
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto p-4 pb-20">
        <div id="loading" class="flex flex-col items-center justify-center py-20">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10 mb-4"></div>
            <p class="text-gray-500 text-sm font-bold animate-pulse">SYNCING WITH CLOUD...</p>
        </div>

        <div id="errorState" class="hidden text-center py-20 px-6">
            <i class="fa-solid fa-circle-exclamation text-red-500 text-5xl mb-4"></i>
            <h3 class="text-lg font-bold uppercase">Update Failed</h3>
            <p class="text-gray-500 mt-2 text-sm" id="errorMessage">Check Spreadsheet Permissions.</p>
            <button onclick="fetchData()" class="mt-6 px-8 py-3 bg-red-600 text-white font-black rounded-xl shadow-lg">RETRY SYNC</button>
        </div>

        <div id="customerList" class="grid gap-3 sm:grid-cols-2"></div>

        <div id="noResults" class="hidden text-center py-20">
            <i class="fa-solid fa-user-slash text-gray-300 text-5xl mb-4"></i>
            <p class="text-gray-500 font-bold">No Records Match This Search</p>
        </div>
    </main>

    <!-- Redesigned Compact Modal for Mobile One-Go View -->
    <div id="detailModal" class="fixed inset-0 z-50 hidden flex items-end sm:items-center justify-center p-0 sm:p-4 bg-black/80 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl overflow-hidden shadow-2xl transition-all transform translate-y-full flex flex-col" id="modalContent">
            
            <!-- Compact Header -->
            <div class="relative h-44 bg-gray-200">
                <img id="modalPhoto" src="" alt="Customer Photo" class="w-full h-full object-cover">
                <button onclick="closeModal()" class="absolute top-3 right-3 bg-black/50 text-white w-8 h-8 rounded-full flex items-center justify-center">
                    <i class="fa-solid fa-xmark"></i>
                </button>
                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-white p-4">
                    <span id="modalId" class="text-[9px] font-black bg-red-600 text-white px-2 py-0.5 rounded-full uppercase tracking-tighter"></span>
                    <h2 id="modalName" class="text-xl font-black text-gray-900 leading-tight selectable truncate"></h2>
                </div>
            </div>

            <!-- Content Body (Compact Spacing) -->
            <div class="px-5 py-4 space-y-4">
                <!-- Address Section -->
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 bg-blue-50 rounded-lg flex items-center justify-center flex-shrink-0">
                        <i class="fa-solid fa-location-dot text-blue-600 text-sm"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-[9px] text-gray-400 font-black uppercase">Address</p>
                        <p id="modalAddress" class="text-sm font-bold text-gray-800 selectable leading-snug"></p>
                    </div>
                </div>

                <!-- Numbers Row -->
                <div class="grid grid-cols-2 gap-3">
                    <div class="flex items-center gap-2 p-2 bg-green-50 rounded-xl border border-green-100">
                        <i class="fa-solid fa-phone text-green-600 text-xs"></i>
                        <div class="min-w-0">
                            <p class="text-[8px] text-green-700 font-black uppercase">Primary</p>
                            <p id="modalPhone" class="text-xs font-black text-gray-900 selectable truncate"></p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 p-2 bg-orange-50 rounded-xl border border-orange-100">
                        <i class="fa-solid fa-phone-flip text-orange-600 text-xs"></i>
                        <div class="min-w-0">
                            <p class="text-[8px] text-orange-700 font-black uppercase">Alternate</p>
                            <p id="modalAltPhone" class="text-xs font-black text-gray-900 selectable truncate"></p>
                        </div>
                    </div>
                </div>

                <!-- Large Action Buttons -->
                <div class="grid grid-cols-2 gap-3 pt-2">
                    <a id="bigCallBtn" href="#" class="flex flex-col items-center justify-center gap-1 py-3 bg-green-600 text-white rounded-2xl font-black text-xs shadow-lg active:scale-95 transition-all">
                        <i class="fa-solid fa-phone text-lg"></i>
                        CALL NOW
                    </a>
                    <a id="directionBtn" href="#" target="_blank" class="flex flex-col items-center justify-center gap-1 py-3 bg-blue-600 text-white rounded-2xl font-black text-xs shadow-lg active:scale-95 transition-all">
                        <i class="fa-solid fa-location-arrow text-lg"></i>
                        DIRECTIONS
                    </a>
                </div>
            </div>
            
            <!-- Modal Bottom Safe Area -->
            <div class="h-6 bg-white w-full"></div>
        </div>
    </div>

    <script>
        const CSV_URL = `https://docs.google.com/spreadsheets/d/e/2PACX-1vSretHvAs4tMhyEZvG7BAFuOYnSk28vfK__jGIb_sbYetP2vGk0-sO8mw29DIRYlAGI6BVdvLDH5H-c/pub?output=csv`;

        let customers = [];
        let columnsMap = {};

        window.onload = fetchData;

        async function fetchData() {
            try {
                document.getElementById('loading').classList.remove('hidden');
                document.getElementById('errorState').classList.add('hidden');
                
                const response = await fetch(CSV_URL);
                if (!response.ok) throw new Error("Check Connection");
                const text = await response.text();
                
                parseFullCSV(text);
                
                document.getElementById('loading').classList.add('hidden');
                renderList(customers);
            } catch (err) {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('errorState').classList.remove('hidden');
                document.getElementById('errorMessage').textContent = err.message;
            }
        }

        function parseFullCSV(text) {
            const rows = text.split(/\r?\n/);
            if (rows.length < 2) return;

            const headerRow = splitCSVRow(rows[0]);
            columnsMap = {
                id: headerRow.findIndex(h => h.toLowerCase().includes('id')),
                name: headerRow.findIndex(h => h.toLowerCase().includes('name')),
                address: headerRow.findIndex(h => h.toLowerCase().includes('address')),
                mobile: headerRow.findIndex(h => h.toLowerCase().includes('mobile') || h.toLowerCase().includes('primary')),
                alt: headerRow.findIndex(h => h.toLowerCase().includes('alternate') || h.toLowerCase().includes('alt')),
                link: headerRow.findIndex(h => h.toLowerCase().includes('link') || h.toLowerCase().includes('location')),
                photo: headerRow.findIndex(h => h.toLowerCase().includes('photo') || h.toLowerCase().includes('home'))
            };

            customers = rows.slice(1).map(row => {
                if (!row.trim()) return null;
                const cols = splitCSVRow(row);
                
                return {
                    id: cols[columnsMap.id] || 'N/A',
                    name: cols[columnsMap.name] || 'Unknown',
                    address: cols[columnsMap.address] || 'Address missing',
                    mobile: cols[columnsMap.mobile] || '',
                    altMobile: cols[columnsMap.alt] || '',
                    location: cols[columnsMap.link] || '',
                    photo: cols[columnsMap.photo] || ''
                };
            }).filter(c => c !== null);

            document.getElementById('customerCount').textContent = customers.length;
        }

        function splitCSVRow(row) {
            const result = [];
            let current = '';
            let inQuote = false;
            for (let i = 0; i < row.length; i++) {
                const char = row[i];
                if (char === '"') {
                    if (inQuote && row[i+1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuote = !inQuote;
                    }
                } else if (char === ',' && !inQuote) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        function renderList(list) {
            const container = document.getElementById('customerList');
            if (list.length === 0) {
                document.getElementById('noResults').classList.remove('hidden');
                container.innerHTML = '';
                return;
            }
            document.getElementById('noResults').classList.add('hidden');
            container.innerHTML = list.map(c => `
                <div class="customer-card bg-white p-3.5 rounded-2xl shadow-sm border border-gray-200 flex items-center gap-4 cursor-pointer" onclick='openModal(${JSON.stringify(c).replace(/'/g, "&apos;")})'>
                    <div class="w-12 h-12 rounded-xl overflow-hidden bg-gray-50 flex-shrink-0 border border-gray-100">
                        <img src="${c.photo || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(c.name) + '&background=random'}" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-[8px] font-black text-red-600 uppercase tracking-widest">${c.id}</p>
                        <h3 class="text-sm font-black text-gray-900 truncate leading-tight">${c.name}</h3>
                        <p class="text-[10px] text-gray-500 truncate font-medium">${c.address}</p>
                    </div>
                    <i class="fa-solid fa-chevron-right text-gray-300 text-[10px]"></i>
                </div>
            `).join('');
        }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            const filtered = customers.filter(c => 
                c.name.toLowerCase().includes(val) || 
                c.id.toLowerCase().includes(val) || 
                c.address.toLowerCase().includes(val)
            );
            renderList(filtered);
            document.getElementById('customerCount').textContent = filtered.length;
        });

        function openModal(c) {
            document.getElementById('modalName').textContent = c.name;
            document.getElementById('modalId').textContent = `ID: ${c.id}`;
            document.getElementById('modalAddress').textContent = c.address;
            document.getElementById('modalPhone').textContent = c.mobile || '---';
            document.getElementById('modalAltPhone').textContent = c.altMobile || '---';
            
            const photo = document.getElementById('modalPhoto');
            photo.src = c.photo || 'https://images.unsplash.com/photo-1564013799919-ab600027ffc6?q=80&w=800';

            const bigCall = document.getElementById('bigCallBtn');
            if (c.mobile) {
                bigCall.href = `tel:${c.mobile.replace(/\D/g, '')}`;
                bigCall.classList.remove('opacity-50', 'pointer-events-none');
            } else {
                bigCall.classList.add('opacity-50', 'pointer-events-none');
            }

            const dir = document.getElementById('directionBtn');
            if (c.location && c.location.includes('http')) {
                dir.href = c.location;
                dir.classList.remove('opacity-50', 'pointer-events-none');
            } else {
                dir.classList.add('opacity-50', 'pointer-events-none');
            }

            document.getElementById('detailModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('modalContent').classList.remove('translate-y-full'), 10);
        }

        function closeModal() {
            document.getElementById('modalContent').classList.add('translate-y-full');
            setTimeout(() => document.getElementById('detailModal').classList.add('hidden'), 300);
        }

        document.getElementById('detailModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('detailModal')) closeModal();
        });
    </script>
</body>
</html>
